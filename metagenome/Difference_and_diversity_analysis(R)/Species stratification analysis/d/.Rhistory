select(all_of(join_column_df1))
# ä½¿ç”¨åå¼•å·å¤„ç†åŒ…å«ç‰¹æ®Šå­—ç¬¦çš„åˆ—å
df2_selected <- df2 %>%
select(taxon, MI35, MI33, MI32, MI38, MI36, MI34, MI37,
MI27, MI28, MI29, MI31, MI17, MI21, MI20, MI24,
MI23, MI26, MI19, MI18, MI15, MI25, MI22, MI14,
MI16, MI1, MI2, MI3, MI4, MI5, MI6, MI7, MI8,
MI9, MI10, MI11, MI12, MI13, CON1, CON2, CON3,
CON4, CON5, CON6, CON7, CON8, CON9, CON10, CON11,
CON12, CON13, CON14, CON15, CON16, CON17, CON18,
CON19, CON20, CON21, CON22, CON23, CON24, CON25,
CON26, CON27, CON28, CON29, CON30, CON31, CON32,
CON33, CON34, CON35, CON36, CON37, CON38, CON39,
CON40, CON41, CON42, CON43, CON44, CON45, CON46,
CON47, `lfc_(Intercept)`, `lfc_GroupMI`, `se_(Intercept)`,
`se_GroupMI`, `W_(Intercept)`, `W_GroupMI`, `p_(Intercept)`,
`p_GroupMI`, `q_(Intercept)`, `q_GroupMI`, `diff_(Intercept)`,
`diff_GroupMI`, `passed_ss_(Intercept)`, `passed_ss_GroupMI`,
`diff_robust_(Intercept)`, `diff_robust_GroupMI`)
# æ‰§è¡Œå·¦è¿æ¥
merged_df <- df2_selected %>%
left_join(df1_selected, by = c("taxon" = join_column_df1))
# ä¿å­˜ç»“æœ
write.xlsx(merged_df, output_path)
cat("æ–‡ä»¶æ‹¼æ¥å®Œæˆï¼\n")
cat("ç»“æœä¿å­˜è·¯å¾„:", output_path, "\n")
cat("åŸå§‹df2è¡Œæ•°:", nrow(df2), "\n")
cat("åˆå¹¶åè¡Œæ•°:", nrow(merged_df), "\n")
cat("åˆ—æ•°:", ncol(merged_df), "\n")
# åŠ è½½å¿…è¦çš„åŒ…
library(readxl)
library(dplyr)
library(openxlsx)
# æ–‡ä»¶è·¯å¾„
file1_path <- "E:/Python/MI_Analysis/metagenome/data_figures/f/ç§‘æ°´å¹³.xlsx"
file2_path <- "E:/Python/MI_Analysis/metagenome/data_figures/f/MaAsLin2_OTU_new/virus/all_results.xlsx"
output_path <- "E:/Python/MI_Analysis/metagenome/data_figures/f/f_MaAsLin2_merged_result.xlsx"
# è¯»å–ä¸¤ä¸ªExcelæ–‡ä»¶
df1 <- read_excel(file1_path)
df2 <- read_excel(file2_path)
# æŸ¥æ‰¾åŒ¹é…çš„åˆ—å
find_join_column <- function(df) {
# æŸ¥æ‰¾åŒ…å«vOTUçš„åˆ—å
vOTU_columns <- grep("vOTU", colnames(df), value = TRUE, ignore.case = TRUE)
if(length(vOTU_columns) > 0) {
return(vOTU_columns[1])
}
# å¦‚æœæ²¡æœ‰æ‰¾åˆ°vOTUåˆ—ï¼Œè¿”å›ç¬¬ä¸€åˆ—
return(colnames(df)[1])
}
# è·å–åŒ¹é…åˆ—å
join_column_df1 <- find_join_column(df1)
cat("ä½¿ç”¨åˆ—è¿›è¡ŒåŒ¹é…:", join_column_df1, "-> taxon\n")
# é€‰æ‹©éœ€è¦çš„åˆ—
df1_selected <- df1 %>%
select(all_of(join_column_df1), MI35, MI33, MI32,
MI38, MI36, MI34, MI37, MI27, MI28, MI29, MI31,
MI17, MI21, MI20, MI24, MI23, MI26, MI19, MI18,
MI15, MI25, MI22, MI14, MI16, MI1, MI2, MI3,
MI4, MI5, MI6, MI7, MI8, MI9, MI10, MI11, MI12,
MI13, CON1, CON2, CON3, CON4, CON5, CON6, CON7,
CON8, CON9, CON10, CON11, CON12, CON13, CON14,
CON15, CON16, CON17, CON18, CON19, CON20, CON21,
CON22, CON23, CON24, CON25, CON26, CON27, CON28,
CON29, CON30, CON31, CON32, CON33, CON34, CON35,
CON36, CON37, CON38, CON39, CON40, CON41, CON42,
CON43, CON44, CON45, CON46, CON47)
# ä½¿ç”¨åå¼•å·å¤„ç†åŒ…å«ç‰¹æ®Šå­—ç¬¦çš„åˆ—å
df2_selected <- df2 %>%
select(feature, metadata, value, coef, stderr, N, N.not.0, pval, qval)
# æ‰§è¡Œå·¦è¿æ¥
merged_df <- df2_selected %>%
left_join(df1_selected, by = c("feature" = join_column_df1))
# ä¿å­˜ç»“æœ
write.xlsx(merged_df, output_path)
cat("æ–‡ä»¶æ‹¼æ¥å®Œæˆï¼\n")
cat("ç»“æœä¿å­˜è·¯å¾„:", output_path, "\n")
cat("åŸå§‹df2è¡Œæ•°:", nrow(df2), "\n")
cat("åˆå¹¶åè¡Œæ•°:", nrow(merged_df), "\n")
cat("åˆ—æ•°:", ncol(merged_df), "\n")
# =============================================================================
# å››ç±»å¾®ç”Ÿç‰© OTU è¡¨ ANCOM-BC2 åˆ†æï¼ˆåŒ…å«åŸå§‹ä¸°åº¦æ•°æ®ï¼‰
# =============================================================================
library(phyloseq)
library(ANCOMBC)
library(openxlsx)
# ----------------------------
# 1. æ–‡ä»¶è·¯å¾„
# ----------------------------
otu_files <- list(
virus = "E:/Python/MI_Analysis/metagenome/data_figures/g/å±æ°´å¹³.xlsx"
)
metadata_file = "E:/Python/MI_Analysis/metagenome/data_figures/g/sample_metadata.xlsx"
# è¾“å‡ºæ–‡ä»¶å¤¹
output_dir <- "E:/Python/MI_Analysis/metagenome/data_figures/g/ancombc2_results_new/"
dir.create(output_dir, showWarnings = FALSE, recursive = TRUE)
# ----------------------------
# 2. è¯»å–å…ƒæ•°æ®
# ----------------------------
metadata <- read.xlsx(metadata_file)
rownames(metadata) <- metadata$SampleID
# ----------------------------
# å¾ªç¯åˆ†æå››ç±»å¾®ç”Ÿç‰©
# ----------------------------
for (microbe in names(otu_files)) {
cat("\næ­£åœ¨åˆ†æ:", microbe, "\n")
# è¯»å– OTU è¡¨
feature_data <- read.xlsx(otu_files[[microbe]], check.names = FALSE)
rownames(feature_data) <- feature_data$å±
feature_data_only <- feature_data[, -1, drop = FALSE]  # åˆ é™¤ ID åˆ—ï¼Œåªä¿ç•™ä¸°åº¦
cat("OTUæ€»æ•°:", nrow(feature_data_only), "\n")
# æ‰“å° OTU ID åˆ—å‰ 6 è¡Œ
cat("\nåŸå§‹OTU IDå‰6è¡Œ:\n")
print(head(feature_data$å±, 6))
# ----------------------------
# æ„å»º phyloseq å¯¹è±¡
# ----------------------------
common_samples <- intersect(colnames(feature_data_only), metadata$SampleID)
feature_data_common <- feature_data_only[, common_samples, drop = FALSE]
metadata_common <- metadata[common_samples, , drop = FALSE]
rownames(metadata_common) <- metadata_common$SampleID
cat("å…±åŒæ ·æœ¬æ•°é‡:", length(common_samples), "\n")
# æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„æ ·æœ¬
if (length(common_samples) < 3) {
cat("è­¦å‘Š: æ ·æœ¬æ•°é‡ä¸è¶³ï¼Œè·³è¿‡", microbe, "\n")
next
}
# æ„å»ºphyloseqå¯¹è±¡æ—¶ä¿ç•™åŸå§‹OTU IDä½œä¸ºè¡Œå
otu <- otu_table(as.matrix(feature_data_common), taxa_are_rows = TRUE)
sam <- sample_data(metadata_common)
ps_obj <- phyloseq(otu, sam)
# ä¿å­˜åŸå§‹OTU IDå’Œä¸°åº¦æ•°æ®
original_taxon_names <- rownames(feature_data_common)
original_abundance_data <- feature_data_common
# ----------------------------
# è¿è¡Œ ANCOM-BC2
# ----------------------------
ancombc_res <- tryCatch({
ancombc2(
data = ps_obj,
fix_formula = "Group",
p_adj_method = "fdr",
lib_cut = 0,
group = "Group",
struc_zero = FALSE,
neg_lb = TRUE,
alpha = 0.05,
n_cl = 6
)
}, error = function(e) {
cat(paste0("ANCOM-BC2åˆ†æå‡ºé”™: ", microbe, " - ", e$message, "\n"))
return(NULL)
})
# ----------------------------
# å¤„ç†ç»“æœ - ä»…ä½¿ç”¨åç§°åŒ¹é…æ–¹æ³•
# ----------------------------
if (!is.null(ancombc_res)) {
res <- ancombc_res$res
# æ·»åŠ ANCOM-BC2ç»“æœè¡Œæ•°ç»Ÿè®¡
cat("==========================================\n")
cat("ANCOM-BC2 ç»“æœç»Ÿè®¡ -", microbe, "\n")
cat("==========================================\n")
cat("åŸå§‹è¾“å…¥OTUæ•°é‡:     ", length(original_taxon_names), "\n")
cat("ANCOM-BC2ç»“æœOTUæ•°é‡:", nrow(res), "\n")
cat("è¿‡æ»¤æ‰çš„OTUæ•°é‡:     ", length(original_taxon_names) - nrow(res), "\n")
cat("ä¿ç•™æ¯”ä¾‹:            ", round(nrow(res)/length(original_taxon_names)*100, 2), "%\n")
# æ£€æŸ¥è¡Œæ•°æ˜¯å¦åŒ¹é…
if (nrow(res) != length(original_taxon_names)) {
cat("è­¦å‘Š: ANCOM-BC2å†…éƒ¨è¿‡æ»¤äº†", length(original_taxon_names) - nrow(res), "ä¸ªOTU\n")
}
# ä½¿ç”¨åç§°åŒ¹é…æ–¹æ³•ï¼šæ£€æŸ¥ANCOM-BC2ç»“æœä¸­çš„ç‰©ç§åç§°æ˜¯å¦åœ¨åŸå§‹åç§°ä¸­
matched_taxa <- intersect(original_taxon_names, res$taxon)
cat("é€šè¿‡åç§°åŒ¹é…çš„ç‰©ç§æ•°é‡:", length(matched_taxa), "\n")
if (length(matched_taxa) == nrow(res)) {
# æƒ…å†µ1: æ‰€æœ‰ç»“æœç‰©ç§éƒ½èƒ½åœ¨åŸå§‹åç§°ä¸­æ‰¾åˆ°
cat("æƒ…å†µ1: æ‰€æœ‰ANCOM-BC2ç»“æœç‰©ç§éƒ½èƒ½åŒ¹é…åˆ°åŸå§‹åç§°\n")
final_res <- res
# è·å–å¯¹åº”çš„ä¸°åº¦æ•°æ®
abundance_data_to_add <- original_abundance_data[final_res$taxon, , drop = FALSE]
} else if (length(matched_taxa) > 0) {
# æƒ…å†µ2: åªæœ‰éƒ¨åˆ†åŒ¹é…ï¼Œä¿ç•™åŒ¹é…çš„ç‰©ç§
cat("æƒ…å†µ2: åªæœ‰éƒ¨åˆ†ç‰©ç§åŒ¹é…ï¼Œä¿ç•™", length(matched_taxa), "ä¸ªåŒ¹é…çš„ç‰©ç§\n")
final_res <- res[res$taxon %in% matched_taxa, ]
# è·å–å¯¹åº”çš„ä¸°åº¦æ•°æ®
abundance_data_to_add <- original_abundance_data[final_res$taxon, , drop = FALSE]
} else {
# æƒ…å†µ3: å¦‚æœå®Œå…¨æ— æ³•åŒ¹é…ï¼Œä½¿ç”¨åŸå§‹åç§°ï¼ˆæŒ‰é¡ºåºï¼‰
cat("æƒ…å†µ3: æ— æ³•é€šè¿‡åç§°åŒ¹é…ï¼Œä½¿ç”¨é¡ºåºæ˜ å°„\n")
final_res <- res
final_res$taxon <- original_taxon_names[1:nrow(res)]
# è·å–å¯¹åº”çš„ä¸°åº¦æ•°æ®
abundance_data_to_add <- original_abundance_data[final_res$taxon, , drop = FALSE]
}
# å°†ä¸°åº¦æ•°æ®æ’å…¥åˆ°taxonåˆ—ä¹‹å
cat("æ­£åœ¨åˆå¹¶ä¸°åº¦æ•°æ®...\n")
# æ‰¾åˆ°taxonåˆ—çš„ä½ç½®
taxon_col_index <- which(colnames(final_res) == "taxon")
# å°†ç»“æœè¡¨åˆ†æˆä¸¤éƒ¨åˆ†ï¼štaxonåˆ—ä¹‹å‰å’Œä¹‹å
before_taxon <- final_res[, 1:taxon_col_index, drop = FALSE]
after_taxon <- final_res[, (taxon_col_index + 1):ncol(final_res), drop = FALSE]
# åˆå¹¶ï¼štaxonåˆ—ä¹‹å‰ + ä¸°åº¦æ•°æ® + taxonåˆ—ä¹‹å
final_res_with_abundance <- cbind(
before_taxon,
abundance_data_to_add,
after_taxon
)
# ä¿æŒåŸå§‹æ ·æœ¬åç§°ï¼Œä¸æ·»åŠ å‰ç¼€
# ä¸°åº¦æ•°æ®åˆ—åä¿æŒä¸å˜
cat("ä¸°åº¦æ•°æ®å·²æˆåŠŸæ’å…¥ï¼Œæ–°å¢", ncol(abundance_data_to_add), "ä¸ªä¸°åº¦åˆ—\n")
# æ‰“å°æœ€ç»ˆç»“æœçš„å‰6è¡Œï¼ˆåªæ˜¾ç¤ºå‰å‡ åˆ—ä»¥å…è¾“å‡ºè¿‡é•¿ï¼‰
cat("\næœ€ç»ˆç»“æœå‰6è¡Œï¼ˆæ˜¾ç¤ºå‰8åˆ—ï¼‰:\n")
print(head(final_res_with_abundance[, 1:min(8, ncol(final_res_with_abundance))], 6))
# ä¿å­˜ä¸º Excel
output_file <- paste0(output_dir, microbe, "_ANCOMBC2_results.xlsx")
wb <- createWorkbook()
addWorksheet(wb, "Complete_Results")
writeData(wb, "Complete_Results", final_res_with_abundance)
saveWorkbook(wb, output_file, overwrite = TRUE)
cat("==========================================\n")
cat(paste0("ANCOM-BC2ç»“æœå·²ä¿å­˜: ", output_file, "\n"))
cat(paste0("ç»“æœè¡¨ç»´åº¦: ", nrow(final_res_with_abundance), " è¡Œ, ", ncol(final_res_with_abundance), " åˆ—\n"))
cat("å…¶ä¸­åŒ…å«", ncol(abundance_data_to_add), "ä¸ªæ ·æœ¬çš„ä¸°åº¦æ•°æ®\n")
cat("==========================================\n\n")
} else {
cat("==========================================\n")
cat(paste0("ANCOM-BC2åˆ†æç»“æœä¸ºç©º: ", microbe, "\n"))
cat("==========================================\n\n")
}
}
# æœ€ç»ˆæ€»ç»“
cat("\n\n==========================================\n")
cat("æ‰€æœ‰åˆ†æå®Œæˆ! æ€»ç»“:\n")
cat("==========================================\n")
for (microbe in names(otu_files)) {
output_file <- paste0(output_dir, microbe, "_ANCOMBC2_results.xlsx")
if (file.exists(output_file)) {
wb <- loadWorkbook(output_file)
sheet_data <- readWorkbook(wb, sheet = 1)
# è®¡ç®—ä¸°åº¦æ•°æ®åˆ—æ•°ï¼ˆç»Ÿè®¡ç»“æœåˆ—é€šå¸¸æœ‰å›ºå®šåç§°ï¼Œå…¶ä»–åˆ—ä¸ºä¸°åº¦æ•°æ®ï¼‰
stat_columns <- c("taxon", "lfc_Group", "se_Group", "W_Group", "p_Group", "q_Group", "diff_Group")
abundance_cols <- ncol(sheet_data) - length(intersect(colnames(sheet_data), stat_columns))
cat(microbe, ": ", nrow(sheet_data), "è¡Œç»“æœ, ", abundance_cols, "ä¸ªæ ·æœ¬çš„ä¸°åº¦æ•°æ®\n")
} else {
cat(microbe, ": æ–‡ä»¶ä¸å­˜åœ¨\n")
}
}
cat("==========================================\n")
# =============================================================================
# è®ºæ–‡çº§ MaAsLin2 åˆ†æï¼šç—…æ¯’/å¤èŒ/ç»†èŒ/çœŸèŒ
# è‡ªåŠ¨ CSVâ†’TSVã€Excelâ†’TSVï¼Œç­›é€‰ q<0.05 & |log2FC|>1ï¼Œåˆå¹¶æ˜¾è‘—ç»“æœå¹¶æ ‡æ³¨å‡é™è¶‹åŠ¿
# ä¿®å¤ç‰¹å¾åä¸­çš„æ‹¬å·é—®é¢˜
# =============================================================================
rm(list = ls())
# ----------------------------
# 1. å®‰è£…ä¾èµ–åŠ MaAsLin2ï¼ˆå¦‚æœæ²¡æœ‰ï¼‰
# ----------------------------
if (!requireNamespace("Maaslin2", quietly = TRUE)) {
if (!requireNamespace("remotes", quietly = TRUE)) install.packages("remotes")
deps <- c("dplyr", "data.table", "ggplot2", "Rcpp", "tibble", "stringr", "reshape2")
for (pkg in deps) if (!requireNamespace(pkg, quietly = TRUE)) install.packages(pkg)
remotes::install_github("biobakery/Maaslin2")
}
library(Maaslin2)
if (!requireNamespace("readxl", quietly = TRUE)) install.packages("readxl")
library(readxl)
library(dplyr)
# ----------------------------
# 2. å®šä¹‰ä¿®å¤å‡½æ•°
# ----------------------------
repair_maaslin_output <- function(output_dir, original_features) {
# ä¿®å¤ significant_results.tsv
sig_file <- file.path(output_dir, "significant_results.tsv")
if (file.exists(sig_file)) {
sig_df <- read.delim(sig_file, check.names = FALSE, stringsAsFactors = FALSE)
if (nrow(sig_df) > 0) {
# åˆ›å»ºç‰¹å¾åæ˜ å°„
feature_map <- data.frame(
cleaned = make.names(original_features, unique = TRUE),
original = as.character(original_features),
stringsAsFactors = FALSE
)
# ä¿®å¤ç‰¹å¾å
sig_df <- sig_df %>%
left_join(feature_map, by = c("feature" = "cleaned")) %>%
mutate(feature = ifelse(!is.na(original), original, feature)) %>%
select(-original)
# ä¿å­˜ä¿®å¤åçš„æ–‡ä»¶
write.table(sig_df, sig_file, sep = "\t", row.names = FALSE, quote = FALSE)
cat("âœ… å·²ä¿®å¤", nrow(sig_df), "ä¸ªç‰¹å¾ååœ¨", basename(sig_file), "\n")
}
}
# ä¿®å¤ all_results.tsv
all_file <- file.path(output_dir, "all_results.tsv")
if (file.exists(all_file)) {
all_df <- read.delim(all_file, check.names = FALSE, stringsAsFactors = FALSE)
if (nrow(all_df) > 0) {
# åˆ›å»ºç‰¹å¾åæ˜ å°„
feature_map <- data.frame(
cleaned = make.names(original_features, unique = TRUE),
original = as.character(original_features),
stringsAsFactors = FALSE
)
# ä¿®å¤ç‰¹å¾å
all_df <- all_df %>%
left_join(feature_map, by = c("feature" = "cleaned")) %>%
mutate(feature = ifelse(!is.na(original), original, feature)) %>%
select(-original)
# ä¿å­˜ä¿®å¤åçš„æ–‡ä»¶
write.table(all_df, all_file, sep = "\t", row.names = FALSE, quote = FALSE)
cat("âœ… å·²ä¿®å¤", nrow(all_df), "ä¸ªç‰¹å¾ååœ¨", basename(all_file), "\n")
}
}
}
# ----------------------------
# 3. æ–‡ä»¶è·¯å¾„
# ----------------------------
files <- list(
virus = "E:/Python/MI_Analysis/metagenome/data_figures/g/å±æ°´å¹³.xlsx"
)
metadata_file <- "E:/Python/MI_Analysis/metagenome/data_figures/g/sample_metadata.xlsx"
outdir <- "E:/Python/MI_Analysis/metagenome/data_figures/g/MaAsLin2_OTU_new/"
if (!dir.exists(outdir)) dir.create(outdir, recursive = TRUE)
# ----------------------------
# 4. è¯»å– metadata å¹¶ä¿å­˜ä¸º TSV
# ----------------------------
metadata <- read_excel(metadata_file)
colnames(metadata)[1] <- "SampleID"
metadata_tsv <- file.path(outdir, "metadata_temp.tsv")
write.table(metadata, metadata_tsv, sep = "\t", row.names = FALSE, quote = FALSE)
# ----------------------------
# 5. æ‰¹é‡åˆ†æ + CSV â†’ TSV è‡ªåŠ¨è½¬æ¢ + ç­›é€‰æ˜¾è‘—
# ----------------------------
all_sig_list <- list()  # ç”¨äºå­˜å‚¨æ¯ç±»å¾®ç”Ÿç‰©çš„æ˜¾è‘—ç»“æœ
for (microbe in names(files)) {
cat("\n=========== å¼€å§‹åˆ†æ:", microbe, "===========\n")
# è¯»å– Excel æ–‡ä»¶
feature <- read_excel(files[[microbe]])
# ä¿å­˜åŸå§‹ç‰¹å¾åï¼ˆå‡è®¾ç¬¬ä¸€åˆ—æ˜¯ç‰¹å¾åï¼‰
if (!colnames(feature)[1] %in% c("Feature", "OTU", "Taxonomy")) {
colnames(feature)[1] <- "Feature"
}
original_features <- feature[[1]]
# è½¬æ¢ä¸º TSV ä¸´æ—¶æ–‡ä»¶ï¼Œç¦ç”¨åˆ—åæ£€æŸ¥ä»¥ä¿æŒåŸåˆ—å
feature_tsv <- file.path(outdir, paste0(microbe, "_temp.tsv"))
write.table(feature, feature_tsv, sep = "\t", row.names = FALSE, quote = FALSE, col.names = TRUE)
# åˆ›å»ºè¾“å‡ºç›®å½•
outdir_microbe <- file.path(outdir, microbe)
if (!dir.exists(outdir_microbe)) dir.create(outdir_microbe)
# è¿è¡Œ MaAsLin2ï¼ˆè®ºæ–‡å»ºè®® q â‰¤ 0.05ï¼‰
Maaslin2(
input_data = feature_tsv,
input_metadata = metadata_tsv,
output = outdir_microbe,
fixed_effects = c("Group"),
normalization = "TSS",
transform = "LOG",
analysis_method = "LM",
max_significance = 0.05
)
# ----------------------------
# ä¿®å¤ MaAsLin2 è¾“å‡ºæ–‡ä»¶ä¸­çš„ç‰¹å¾å
# ----------------------------
cat("ğŸ”§ ä¿®å¤ç‰¹å¾åä¸­çš„æ‹¬å·é—®é¢˜...\n")
repair_maaslin_output(outdir_microbe, original_features)
# ----------------------------
# è¯»å–æ˜¾è‘—ç»“æœå¹¶ç­›é€‰ q<0.05 & |log2FC|>1
# ----------------------------
sig_file <- file.path(outdir_microbe, "significant_results.tsv")
if (file.exists(sig_file)) {
sig_df <- read.delim(sig_file, check.names = FALSE, stringsAsFactors = FALSE)
if (nrow(sig_df) > 0) {
# ä½¿ç”¨ coef è¿‘ä¼¼ log2FCï¼ˆå¦‚æœ MaAsLin2 å·²ç»è¾“å‡º log2FCï¼Œå¯æ”¹ç”¨ log2FC åˆ—ï¼‰
sig_df$log2FC <- sig_df$coef
# ç­›é€‰æ¡ä»¶
sig_df <- sig_df %>% filter(qval < 0.05 & abs(log2FC) > 1)
if (nrow(sig_df) > 0) {
# æ ‡æ³¨å‡é™è¶‹åŠ¿
sig_df$Trend <- ifelse(sig_df$log2FC > 0, "Up", "Down")
sig_df$MicrobeClass <- microbe
all_sig_list[[microbe]] <- sig_df
# æ˜¾ç¤ºä¿®å¤åçš„ç‰¹å¾å
cat("âœ… ", microbe, "æ˜¾è‘— feature æ•°é‡ï¼ˆq<0.05 & |log2FC|>1ï¼‰ï¼š", nrow(sig_df), "\n")
cat("ğŸ“ æ˜¾è‘—ç‰¹å¾åï¼š", paste(sig_df$feature, collapse = ", "), "\n")
} else {
cat("âš ï¸ ", microbe, "æ²¡æœ‰æ»¡è¶³ q<0.05 & |log2FC|>1 çš„ feature\n")
}
} else {
cat("âš ï¸ ", microbe, "æ²¡æœ‰æ˜¾è‘— feature\n")
}
} else {
cat("âš ï¸ ", microbe, "æ˜¾è‘—ç»“æœæ–‡ä»¶ä¸å­˜åœ¨\n")
}
}
# ----------------------------
# 6. åˆå¹¶å››ç±»å¾®ç”Ÿç‰©æ˜¾è‘—ç»“æœå¹¶ä¿å­˜
# ----------------------------
if (length(all_sig_list) > 0) {
combined_sig <- bind_rows(all_sig_list)
combined_file <- file.path(outdir, "combined_significant_results_q0.05_log2fc1.tsv")
write.table(combined_sig, combined_file, sep = "\t", row.names = FALSE, quote = FALSE)
cat("\nğŸ‰ åˆå¹¶åçš„æ˜¾è‘—ç»“æœä¿å­˜åœ¨ï¼š", combined_file, "\n")
cat("ğŸ“Š æ€»æ˜¾è‘—ç‰¹å¾æ•°é‡ï¼š", nrow(combined_sig), "\n")
} else {
cat("\nâš ï¸ æ‰€æœ‰å¾®ç”Ÿç‰©ç±»æ²¡æœ‰æ˜¾è‘— featureï¼Œæœªç”Ÿæˆåˆå¹¶è¡¨\n")
}
cat("\nğŸ‰ æ‰€æœ‰åˆ†æå®Œæˆï¼ç»“æœä¿å­˜åœ¨ï¼š", outdir, "\n")
# åŠ è½½å¿…è¦çš„åŒ…
library(readxl)
library(dplyr)
library(openxlsx)
# æ–‡ä»¶è·¯å¾„
file1_path <- "E:/Python/MI_Analysis/metagenome/data_figures/g/å±æ°´å¹³.xlsx"
file2_path <- "E:/Python/MI_Analysis/metagenome/data_figures/g/ancombc2_results_new/virus_ANCOMBC2_results.xlsx"
output_path <- "E:/Python/MI_Analysis/metagenome/data_figures/g/g_ANCOM-BC2_merged_result.xlsx"
# è¯»å–ä¸¤ä¸ªExcelæ–‡ä»¶
df1 <- read_excel(file1_path)
df2 <- read_excel(file2_path)
# æŸ¥æ‰¾åŒ¹é…çš„åˆ—å
find_join_column <- function(df) {
# æŸ¥æ‰¾åŒ…å«vOTUçš„åˆ—å
vOTU_columns <- grep("vOTU", colnames(df), value = TRUE, ignore.case = TRUE)
if(length(vOTU_columns) > 0) {
return(vOTU_columns[1])
}
# å¦‚æœæ²¡æœ‰æ‰¾åˆ°vOTUåˆ—ï¼Œè¿”å›ç¬¬ä¸€åˆ—
return(colnames(df)[1])
}
# è·å–åŒ¹é…åˆ—å
join_column_df1 <- find_join_column(df1)
cat("ä½¿ç”¨åˆ—è¿›è¡ŒåŒ¹é…:", join_column_df1, "-> taxon\n")
# é€‰æ‹©éœ€è¦çš„åˆ—
df1_selected <- df1 %>%
select(all_of(join_column_df1))
# ä½¿ç”¨åå¼•å·å¤„ç†åŒ…å«ç‰¹æ®Šå­—ç¬¦çš„åˆ—å
df2_selected <- df2 %>%
select(taxon, MI35, MI33, MI32, MI38, MI36, MI34, MI37,
MI27, MI28, MI29, MI31, MI17, MI21, MI20, MI24,
MI23, MI26, MI19, MI18, MI15, MI25, MI22, MI14,
MI16, MI1, MI2, MI3, MI4, MI5, MI6, MI7, MI8,
MI9, MI10, MI11, MI12, MI13, CON1, CON2, CON3,
CON4, CON5, CON6, CON7, CON8, CON9, CON10, CON11,
CON12, CON13, CON14, CON15, CON16, CON17, CON18,
CON19, CON20, CON21, CON22, CON23, CON24, CON25,
CON26, CON27, CON28, CON29, CON30, CON31, CON32,
CON33, CON34, CON35, CON36, CON37, CON38, CON39,
CON40, CON41, CON42, CON43, CON44, CON45, CON46,
CON47, `lfc_(Intercept)`, `lfc_GroupMI`, `se_(Intercept)`,
`se_GroupMI`, `W_(Intercept)`, `W_GroupMI`, `p_(Intercept)`,
`p_GroupMI`, `q_(Intercept)`, `q_GroupMI`, `diff_(Intercept)`,
`diff_GroupMI`, `passed_ss_(Intercept)`, `passed_ss_GroupMI`,
`diff_robust_(Intercept)`, `diff_robust_GroupMI`)
# æ‰§è¡Œå·¦è¿æ¥
merged_df <- df2_selected %>%
left_join(df1_selected, by = c("taxon" = join_column_df1))
# ä¿å­˜ç»“æœ
write.xlsx(merged_df, output_path)
cat("æ–‡ä»¶æ‹¼æ¥å®Œæˆï¼\n")
cat("ç»“æœä¿å­˜è·¯å¾„:", output_path, "\n")
cat("åŸå§‹df2è¡Œæ•°:", nrow(df2), "\n")
cat("åˆå¹¶åè¡Œæ•°:", nrow(merged_df), "\n")
cat("åˆ—æ•°:", ncol(merged_df), "\n")
# åŠ è½½å¿…è¦çš„åŒ…
library(readxl)
library(dplyr)
library(openxlsx)
# æ–‡ä»¶è·¯å¾„
file1_path <- "E:/Python/MI_Analysis/metagenome/data_figures/g/å±æ°´å¹³.xlsx"
file2_path <- "E:/Python/MI_Analysis/metagenome/data_figures/g/MaAsLin2_OTU_new/virus/all_results.xlsx"
output_path <- "E:/Python/MI_Analysis/metagenome/data_figures/g/g_MaAsLin2_merged_result.xlsx"
# è¯»å–ä¸¤ä¸ªExcelæ–‡ä»¶
df1 <- read_excel(file1_path)
df2 <- read_excel(file2_path)
# æŸ¥æ‰¾åŒ¹é…çš„åˆ—å
find_join_column <- function(df) {
# æŸ¥æ‰¾åŒ…å«vOTUçš„åˆ—å
vOTU_columns <- grep("vOTU", colnames(df), value = TRUE, ignore.case = TRUE)
if(length(vOTU_columns) > 0) {
return(vOTU_columns[1])
}
# å¦‚æœæ²¡æœ‰æ‰¾åˆ°vOTUåˆ—ï¼Œè¿”å›ç¬¬ä¸€åˆ—
return(colnames(df)[1])
}
# è·å–åŒ¹é…åˆ—å
join_column_df1 <- find_join_column(df1)
cat("ä½¿ç”¨åˆ—è¿›è¡ŒåŒ¹é…:", join_column_df1, "-> taxon\n")
# é€‰æ‹©éœ€è¦çš„åˆ—
df1_selected <- df1 %>%
select(all_of(join_column_df1), MI35, MI33, MI32,
MI38, MI36, MI34, MI37, MI27, MI28, MI29, MI31,
MI17, MI21, MI20, MI24, MI23, MI26, MI19, MI18,
MI15, MI25, MI22, MI14, MI16, MI1, MI2, MI3,
MI4, MI5, MI6, MI7, MI8, MI9, MI10, MI11, MI12,
MI13, CON1, CON2, CON3, CON4, CON5, CON6, CON7,
CON8, CON9, CON10, CON11, CON12, CON13, CON14,
CON15, CON16, CON17, CON18, CON19, CON20, CON21,
CON22, CON23, CON24, CON25, CON26, CON27, CON28,
CON29, CON30, CON31, CON32, CON33, CON34, CON35,
CON36, CON37, CON38, CON39, CON40, CON41, CON42,
CON43, CON44, CON45, CON46, CON47)
# ä½¿ç”¨åå¼•å·å¤„ç†åŒ…å«ç‰¹æ®Šå­—ç¬¦çš„åˆ—å
df2_selected <- df2 %>%
select(feature, metadata, value, coef, stderr, N, N.not.0, pval, qval)
# æ‰§è¡Œå·¦è¿æ¥
merged_df <- df2_selected %>%
left_join(df1_selected, by = c("feature" = join_column_df1))
# ä¿å­˜ç»“æœ
write.xlsx(merged_df, output_path)
cat("æ–‡ä»¶æ‹¼æ¥å®Œæˆï¼\n")
cat("ç»“æœä¿å­˜è·¯å¾„:", output_path, "\n")
cat("åŸå§‹df2è¡Œæ•°:", nrow(df2), "\n")
cat("åˆå¹¶åè¡Œæ•°:", nrow(merged_df), "\n")
cat("åˆ—æ•°:", ncol(merged_df), "\n")
