rownames(abundance) <- df$taxon
abundance <- as.data.frame(t(abundance))
# 提取统计信息
stats_info <- list()
if ("lfc_GroupMI" %in% colnames(df)) {
stats_info$lfc_GroupMI <- setNames(df$lfc_GroupMI, df$taxon)
}
if ("q_GroupMI" %in% colnames(df)) {
stats_info$q_GroupMI <- setNames(df$q_GroupMI, df$taxon)
}
cat(name, "- 样本数:", nrow(abundance), "物种数:", ncol(abundance), "\n")
return(list(abundance = abundance, stats = stats_info))
}
# 预处理数据
bacteria_data <- preprocess_data(bacteria_df, "细菌")
virus_data <- preprocess_data(virus_df, "病毒")
bacteria_abundance <- bacteria_data$abundance
virus_abundance <- virus_data$abundance
# 根据样本分组分离数据
mi_samples <- grep("^MI[0-9]+$", rownames(bacteria_abundance), value = TRUE)
con_samples <- grep("^CON[0-9]+$", rownames(bacteria_abundance), value = TRUE)
bacteria_abundance_mi <- bacteria_abundance[mi_samples, ]
virus_abundance_mi <- virus_abundance[mi_samples, ]
bacteria_abundance_con <- bacteria_abundance[con_samples, ]
virus_abundance_con <- virus_abundance[con_samples, ]
# 计算Spearman相关性（分组）
calculate_correlation <- function(bact_abund, vir_abund) {
cor_matrix <- matrix(NA, nrow = ncol(bact_abund), ncol = ncol(vir_abund))
pval_matrix <- matrix(NA, nrow = ncol(bact_abund), ncol = ncol(vir_abund))
rownames(cor_matrix) <- colnames(bact_abund)
colnames(cor_matrix) <- colnames(vir_abund)
rownames(pval_matrix) <- colnames(bact_abund)
colnames(pval_matrix) <- colnames(vir_abund)
for (i in 1:ncol(bact_abund)) {
for (j in 1:ncol(vir_abund)) {
result <- cor.test(bact_abund[, i], vir_abund[, j],
method = "spearman", exact = FALSE)
cor_matrix[i, j] <- result$estimate
pval_matrix[i, j] <- result$p.value
}
}
return(list(correlation = cor_matrix, pvalue = pval_matrix))
}
# 分别计算MI组和CON组的相关性
cor_results_mi <- calculate_correlation(bacteria_abundance_mi, virus_abundance_mi)
cor_matrix_mi <- cor_results_mi$correlation
pval_matrix_mi <- cor_results_mi$pvalue
cor_results_con <- calculate_correlation(bacteria_abundance_con, virus_abundance_con)
cor_matrix_con <- cor_results_con$correlation
pval_matrix_con <- cor_results_con$pvalue
# Nature风格的颜色配置
nature_colors <- list(
correlation = colorRamp2(
c(-1, -0.5, 0, 0.5, 1),
c("#2166AC", "#67A9CF", "#F7F7F7", "#EF8A62", "#B2182B")
),
lfc_up = "#D73027",
lfc_down = "#4575B4",
significance = c("NS" = "lightgray", "*" = "black", "**" = "black", "***" = "black")
)
# 创建显著性标注函数
create_significance_annotation <- function(pval_matrix) {
sig_matrix <- matrix("NS", nrow = nrow(pval_matrix), ncol = ncol(pval_matrix))
sig_matrix[pval_matrix < 0.05] <- "*"
sig_matrix[pval_matrix < 0.01] <- "**"
sig_matrix[pval_matrix < 0.001] <- "***"
rownames(sig_matrix) <- rownames(pval_matrix)
colnames(sig_matrix) <- colnames(pval_matrix)
return(sig_matrix)
}
sig_matrix_mi <- create_significance_annotation(pval_matrix_mi)
sig_matrix_con <- create_significance_annotation(pval_matrix_con)
# 创建行注释（细菌）- 两组共用
bacteria_lfc <- bacteria_data$stats$lfc_GroupMI[rownames(cor_matrix_mi)]
bacteria_qval <- bacteria_data$stats$q_GroupMI[rownames(cor_matrix_mi)]
row_ha <- rowAnnotation(
LFC = anno_simple(
bacteria_lfc,
col = nature_colors$correlation,
na_col = "white",
width = unit(0.2, "cm")
),
Regulation = anno_simple(
ifelse(bacteria_lfc > 0, "Up", "Down"),
col = c("Up" = nature_colors$lfc_up, "Down" = nature_colors$lfc_down),
width = unit(0.2, "cm")
),
annotation_name_side = "top",
annotation_name_gp = gpar(fontsize = 4, family = "SimHei"),
annotation_name_offset = unit(0.5, "cm")
)
# 创建列注释（病毒）- 两组共用
virus_lfc <- virus_data$stats$lfc_GroupMI[colnames(cor_matrix_mi)]
virus_qval <- virus_data$stats$q_GroupMI[colnames(cor_matrix_mi)]
col_ha <- columnAnnotation(
LFC = anno_simple(
virus_lfc,
col = nature_colors$correlation,
na_col = "white",
height = unit(0.2, "cm")
),
Regulation = anno_simple(
ifelse(virus_lfc > 0, "Up", "Down"),
col = c("Up" = nature_colors$lfc_up, "Down" = nature_colors$lfc_down),
height = unit(0.2, "cm")
),
annotation_name_side = "left",
annotation_name_gp = gpar(fontsize = 4, family = "SimHei")
)
# 创建MI组热图
heatmap_mi <- Heatmap(
cor_matrix_mi,
name = "Spearman\nCorrelation\n(MI Group)",
col = nature_colors$correlation,
rect_gp = gpar(col = "white", lwd = 1),
cluster_rows = TRUE,
cluster_columns = TRUE,
show_row_names = TRUE,
show_column_names = TRUE,
row_names_gp = gpar(fontsize = 6, family = "SimHei"),
column_names_gp = gpar(fontsize = 3, family = "SimHei"),
column_names_rot = 45,
row_title = "Bacterial Species",
column_title = "MI Group - Viral Species",
row_title_gp = gpar(fontsize = 8, fontface = "bold", family = "SimHei"),
column_title_gp = gpar(fontsize = 8, fontface = "bold", family = "SimHei"),
row_title_side = "left",
column_title_side = "top",
left_annotation = row_ha,
top_annotation = col_ha,
heatmap_legend_param = list(
title_gp = gpar(fontsize = 6, fontface = "bold", family = "SimHei"),
labels_gp = gpar(fontsize = 4, family = "SimHei"),
legend_direction = "vertical",
title_position = "topcenter",
legend_height = unit(4, "cm")
),
heatmap_width = unit(0.15, "npc"),
heatmap_height = unit(0.15, "npc"),
cell_fun = function(j, i, x, y, width, height, fill) {
if(sig_matrix_mi[i, j] != "NS") {
grid.text(sig_matrix_mi[i, j], x, y, gp = gpar(fontsize = 8, fontface = "bold"))
}
}
)
# 创建CON组热图
heatmap_con <- Heatmap(
cor_matrix_con,
name = "Spearman\nCorrelation\n(CON Group)",
col = nature_colors$correlation,
rect_gp = gpar(col = "white", lwd = 1),
cluster_rows = TRUE,
cluster_columns = TRUE,
show_row_names = TRUE,
show_column_names = TRUE,
row_names_gp = gpar(fontsize = 6, family = "SimHei"),
column_names_gp = gpar(fontsize = 3, family = "SimHei"),
column_names_rot = 45,
row_title = "Bacterial Species",
column_title = "CON Group - Viral Species",
row_title_gp = gpar(fontsize = 8, fontface = "bold", family = "SimHei"),
column_title_gp = gpar(fontsize = 8, fontface = "bold", family = "SimHei"),
row_title_side = "left",
column_title_side = "top",
left_annotation = row_ha,
top_annotation = col_ha,
heatmap_legend_param = list(
title_gp = gpar(fontsize = 6, fontface = "bold", family = "SimHei"),
labels_gp = gpar(fontsize = 4, family = "SimHei"),
legend_direction = "vertical",
title_position = "topcenter",
legend_height = unit(4, "cm")
),
heatmap_width = unit(0.15, "npc"),
heatmap_height = unit(0.15, "npc"),
cell_fun = function(j, i, x, y, width, height, fill) {
if(sig_matrix_con[i, j] != "NS") {
grid.text(sig_matrix_con[i, j], x, y, gp = gpar(fontsize = 8, fontface = "bold"))
}
}
)
# 保存分组PDF - MI组
pdf("Bacteria_Virus_Correlation_MI_Group.pdf",
width = 16, height = 12)
draw(heatmap_mi,
heatmap_legend_side = "left",
annotation_legend_side = "left",
column_title = "MI Group - Bacteria-Virus Correlation Analysis",
column_title_gp = gpar(fontsize = 16, fontface = "bold", family = "SimHei"),
padding = unit(c(8, 8, 8, 8), "cm"))
dev.off()
# 保存分组PDF - CON组
pdf("Bacteria_Virus_Correlation_CON_Group.pdf",
width = 16, height = 12)
draw(heatmap_con,
heatmap_legend_side = "left",
annotation_legend_side = "left",
column_title = "CON Group - Bacteria-Virus Correlation Analysis",
column_title_gp = gpar(fontsize = 16, fontface = "bold", family = "SimHei"),
padding = unit(c(8, 8, 8, 8), "cm"))
dev.off()
# 保存组合PDF（两个热图并排）
pdf("Bacteria_Virus_Correlation_Both_Groups.pdf",
width = 32, height = 12)
draw(heatmap_mi + heatmap_con,
heatmap_legend_side = "left",
column_title = "Bacteria-Virus Correlation Analysis (MI Group vs CON Group)",
column_title_gp = gpar(fontsize = 18, fontface = "bold", family = "SimHei"),
padding = unit(c(4, 4, 4, 4), "cm"))
dev.off()
# 保存相关性结果
write.csv(cor_matrix_mi, "correlation_matrix_MI.csv")
write.csv(pval_matrix_mi, "pvalue_matrix_MI.csv")
write.csv(cor_matrix_con, "correlation_matrix_CON.csv")
write.csv(pval_matrix_con, "pvalue_matrix_CON.csv")
cat("分析完成！结果已保存到:", base_path, "\n")
cat("生成的文件:\n")
cat("- Bacteria_Virus_Correlation_MI_Group.pdf (MI组热图)\n")
cat("- Bacteria_Virus_Correlation_CON_Group.pdf (CON组热图)\n")
cat("- Bacteria_Virus_Correlation_Both_Groups.pdf (两组并排热图)\n")
cat("- correlation_matrix_MI.csv (MI组相关性矩阵)\n")
cat("- correlation_matrix_CON.csv (CON组相关性矩阵)\n")
cat("- pvalue_matrix_MI.csv (MI组P值矩阵)\n")
cat("- pvalue_matrix_CON.csv (CON组P值矩阵)\n")
# 显示统计信息
cat("\n分析统计:\n")
cat("MI组 - 样本数:", length(mi_samples), "显著相关性:", sum(pval_matrix_mi < 0.05, na.rm = TRUE), "\n")
cat("CON组 - 样本数:", length(con_samples), "显著相关性:", sum(pval_matrix_con < 0.05, na.rm = TRUE), "\n")
# 安装必要的包（如果尚未安装）
if (!requireNamespace("BiocManager", quietly = TRUE))
install.packages("BiocManager")
required_packages <- c("readxl", "dplyr", "tidyr", "RColorBrewer", "circlize", "showtext")
for (pkg in required_packages) {
if (!requireNamespace(pkg, quietly = TRUE)) {
install.packages(pkg)
}
}
# 安装Bioconductor包
bioc_packages <- c("ComplexHeatmap")
for (pkg in bioc_packages) {
if (!requireNamespace(pkg, quietly = TRUE)) {
BiocManager::install(pkg)
}
}
# 加载必要的包
library(readxl)
library(ComplexHeatmap)
library(circlize)
library(dplyr)
library(tidyr)
library(RColorBrewer)
library(showtext)
# 设置中文字体
font_add("SimHei", "simhei.ttf")  # Windows系统
showtext_auto()
# 设置工作目录和文件路径
base_path <- "E:/Python/MI_Analysis/metagenome/Absolute_abundance_analysis/By_group_Layered_host_viral_data_differential_bacterial_mixture_analysis"
setwd(base_path)
# 读取数据
metadata <- read_excel("sample_metadata.xlsx")
bacteria_df <- read_excel("Species_stratification_host_integration.xlsx")
virus_df <- read_excel("differential_bacteria.xlsx")
# 数据预处理函数
preprocess_data <- function(df, name) {
# 识别样本列
sample_cols <- grep("^(CON|MI)[0-9]+$", colnames(df), value = TRUE)
# 提取丰度矩阵
abundance <- df[, sample_cols] %>% as.data.frame()
rownames(abundance) <- df$taxon
abundance <- as.data.frame(t(abundance))
# 提取统计信息
stats_info <- list()
if ("lfc_GroupMI" %in% colnames(df)) {
stats_info$lfc_GroupMI <- setNames(df$lfc_GroupMI, df$taxon)
}
if ("q_GroupMI" %in% colnames(df)) {
stats_info$q_GroupMI <- setNames(df$q_GroupMI, df$taxon)
}
cat(name, "- 样本数:", nrow(abundance), "物种数:", ncol(abundance), "\n")
return(list(abundance = abundance, stats = stats_info))
}
# 预处理数据
bacteria_data <- preprocess_data(bacteria_df, "细菌")
virus_data <- preprocess_data(virus_df, "病毒")
bacteria_abundance <- bacteria_data$abundance
virus_abundance <- virus_data$abundance
# 根据样本分组分离数据
mi_samples <- grep("^MI[0-9]+$", rownames(bacteria_abundance), value = TRUE)
con_samples <- grep("^CON[0-9]+$", rownames(bacteria_abundance), value = TRUE)
bacteria_abundance_mi <- bacteria_abundance[mi_samples, ]
virus_abundance_mi <- virus_abundance[mi_samples, ]
bacteria_abundance_con <- bacteria_abundance[con_samples, ]
virus_abundance_con <- virus_abundance[con_samples, ]
# 计算Spearman相关性（分组）
calculate_correlation <- function(bact_abund, vir_abund) {
cor_matrix <- matrix(NA, nrow = ncol(bact_abund), ncol = ncol(vir_abund))
pval_matrix <- matrix(NA, nrow = ncol(bact_abund), ncol = ncol(vir_abund))
rownames(cor_matrix) <- colnames(bact_abund)
colnames(cor_matrix) <- colnames(vir_abund)
rownames(pval_matrix) <- colnames(bact_abund)
colnames(pval_matrix) <- colnames(vir_abund)
for (i in 1:ncol(bact_abund)) {
for (j in 1:ncol(vir_abund)) {
result <- cor.test(bact_abund[, i], vir_abund[, j],
method = "spearman", exact = FALSE)
cor_matrix[i, j] <- result$estimate
pval_matrix[i, j] <- result$p.value
}
}
return(list(correlation = cor_matrix, pvalue = pval_matrix))
}
# 分别计算MI组和CON组的相关性
cor_results_mi <- calculate_correlation(bacteria_abundance_mi, virus_abundance_mi)
cor_matrix_mi <- cor_results_mi$correlation
pval_matrix_mi <- cor_results_mi$pvalue
cor_results_con <- calculate_correlation(bacteria_abundance_con, virus_abundance_con)
cor_matrix_con <- cor_results_con$correlation
pval_matrix_con <- cor_results_con$pvalue
# Nature风格的颜色配置
nature_colors <- list(
correlation = colorRamp2(
c(-1, -0.5, 0, 0.5, 1),
c("#2166AC", "#67A9CF", "#F7F7F7", "#EF8A62", "#B2182B")
),
lfc_up = "#D73027",
lfc_down = "#4575B4",
significance = c("NS" = "lightgray", "*" = "black", "**" = "black", "***" = "black")
)
# 创建显著性标注函数
create_significance_annotation <- function(pval_matrix) {
sig_matrix <- matrix("NS", nrow = nrow(pval_matrix), ncol = ncol(pval_matrix))
sig_matrix[pval_matrix < 0.05] <- "*"
sig_matrix[pval_matrix < 0.01] <- "**"
sig_matrix[pval_matrix < 0.001] <- "***"
rownames(sig_matrix) <- rownames(pval_matrix)
colnames(sig_matrix) <- colnames(pval_matrix)
return(sig_matrix)
}
sig_matrix_mi <- create_significance_annotation(pval_matrix_mi)
sig_matrix_con <- create_significance_annotation(pval_matrix_con)
# 创建行注释（细菌）- 两组共用
bacteria_lfc <- bacteria_data$stats$lfc_GroupMI[rownames(cor_matrix_mi)]
bacteria_qval <- bacteria_data$stats$q_GroupMI[rownames(cor_matrix_mi)]
row_ha <- rowAnnotation(
LFC = anno_simple(
bacteria_lfc,
col = nature_colors$correlation,
na_col = "white",
width = unit(0.2, "cm")
),
Regulation = anno_simple(
ifelse(bacteria_lfc > 0, "Up", "Down"),
col = c("Up" = nature_colors$lfc_up, "Down" = nature_colors$lfc_down),
width = unit(0.2, "cm")
),
annotation_name_side = "top",
annotation_name_gp = gpar(fontsize = 4, family = "SimHei"),
annotation_name_offset = unit(0.5, "cm")
)
# 创建列注释（病毒）- 两组共用
virus_lfc <- virus_data$stats$lfc_GroupMI[colnames(cor_matrix_mi)]
virus_qval <- virus_data$stats$q_GroupMI[colnames(cor_matrix_mi)]
col_ha <- columnAnnotation(
LFC = anno_simple(
virus_lfc,
col = nature_colors$correlation,
na_col = "white",
height = unit(0.2, "cm")
),
Regulation = anno_simple(
ifelse(virus_lfc > 0, "Up", "Down"),
col = c("Up" = nature_colors$lfc_up, "Down" = nature_colors$lfc_down),
height = unit(0.2, "cm")
),
annotation_name_side = "left",
annotation_name_gp = gpar(fontsize = 4, family = "SimHei")
)
# 创建MI组热图
heatmap_mi <- Heatmap(
cor_matrix_mi,
name = "Spearman\nCorrelation\n(MI Group)",
col = nature_colors$correlation,
rect_gp = gpar(col = "white", lwd = 1),
cluster_rows = TRUE,
cluster_columns = TRUE,
show_row_names = TRUE,
show_column_names = TRUE,
row_names_gp = gpar(fontsize = 6, family = "SimHei"),
column_names_gp = gpar(fontsize = 3, family = "SimHei"),
column_names_rot = 45,
row_title = "Bacterial Species",
column_title = "MI Group - Viral Species",
row_title_gp = gpar(fontsize = 8, fontface = "bold", family = "SimHei"),
column_title_gp = gpar(fontsize = 8, fontface = "bold", family = "SimHei"),
row_title_side = "left",
column_title_side = "top",
left_annotation = row_ha,
top_annotation = col_ha,
heatmap_legend_param = list(
title_gp = gpar(fontsize = 6, fontface = "bold", family = "SimHei"),
labels_gp = gpar(fontsize = 4, family = "SimHei"),
legend_direction = "vertical",
title_position = "topcenter",
legend_height = unit(4, "cm")
),
heatmap_width = unit(0.15, "npc"),
heatmap_height = unit(0.15, "npc"),
cell_fun = function(j, i, x, y, width, height, fill) {
if(sig_matrix_mi[i, j] != "NS") {
# 将*号竖着排列并减小字体
stars <- strsplit(sig_matrix_mi[i, j], "")[[1]]
n_stars <- length(stars)
for(k in 1:n_stars) {
grid.text(stars[k],
x = x,
y = y - unit((k-1) * 0.015, "npc"),  # 垂直偏移
gp = gpar(fontsize = 4, fontface = "bold"))  # 减小字体大小
}
}
}
)
# 创建CON组热图
heatmap_con <- Heatmap(
cor_matrix_con,
name = "Spearman\nCorrelation\n(CON Group)",
col = nature_colors$correlation,
rect_gp = gpar(col = "white", lwd = 1),
cluster_rows = TRUE,
cluster_columns = TRUE,
show_row_names = TRUE,
show_column_names = TRUE,
row_names_gp = gpar(fontsize = 6, family = "SimHei"),
column_names_gp = gpar(fontsize = 3, family = "SimHei"),
column_names_rot = 45,
row_title = "Bacterial Species",
column_title = "CON Group - Viral Species",
row_title_gp = gpar(fontsize = 8, fontface = "bold", family = "SimHei"),
column_title_gp = gpar(fontsize = 8, fontface = "bold", family = "SimHei"),
row_title_side = "left",
column_title_side = "top",
left_annotation = row_ha,
top_annotation = col_ha,
heatmap_legend_param = list(
title_gp = gpar(fontsize = 6, fontface = "bold", family = "SimHei"),
labels_gp = gpar(fontsize = 4, family = "SimHei"),
legend_direction = "vertical",
title_position = "topcenter",
legend_height = unit(4, "cm")
),
heatmap_width = unit(0.15, "npc"),
heatmap_height = unit(0.15, "npc"),
cell_fun = function(j, i, x, y, width, height, fill) {
if(sig_matrix_con[i, j] != "NS") {
# 将*号竖着排列并减小字体
stars <- strsplit(sig_matrix_con[i, j], "")[[1]]
n_stars <- length(stars)
for(k in 1:n_stars) {
grid.text(stars[k],
x = x,
y = y - unit((k-1) * 0.015, "npc"),  # 垂直偏移
gp = gpar(fontsize = 4, fontface = "bold"))  # 减小字体大小
}
}
}
)
# 保存分组PDF - MI组
pdf("Bacteria_Virus_Correlation_MI_Group.pdf",
width = 16, height = 12)
draw(heatmap_mi,
heatmap_legend_side = "left",
annotation_legend_side = "left",
column_title = "MI Group - Bacteria-Virus Correlation Analysis",
column_title_gp = gpar(fontsize = 16, fontface = "bold", family = "SimHei"),
padding = unit(c(8, 8, 8, 8), "cm"))
dev.off()
# 保存分组PDF - CON组
pdf("Bacteria_Virus_Correlation_CON_Group.pdf",
width = 16, height = 12)
draw(heatmap_con,
heatmap_legend_side = "left",
annotation_legend_side = "left",
column_title = "CON Group - Bacteria-Virus Correlation Analysis",
column_title_gp = gpar(fontsize = 16, fontface = "bold", family = "SimHei"),
padding = unit(c(8, 8, 8, 8), "cm"))
dev.off()
# 保存组合PDF（两个热图并排）
pdf("Bacteria_Virus_Correlation_Both_Groups.pdf",
width = 32, height = 12)
draw(heatmap_mi + heatmap_con,
heatmap_legend_side = "left",
column_title = "Bacteria-Virus Correlation Analysis (MI Group vs CON Group)",
column_title_gp = gpar(fontsize = 18, fontface = "bold", family = "SimHei"),
padding = unit(c(4, 4, 4, 4), "cm"))
dev.off()
# 保存相关性结果
write.csv(cor_matrix_mi, "correlation_matrix_MI.csv")
write.csv(pval_matrix_mi, "pvalue_matrix_MI.csv")
write.csv(cor_matrix_con, "correlation_matrix_CON.csv")
write.csv(pval_matrix_con, "pvalue_matrix_CON.csv")
cat("分析完成！结果已保存到:", base_path, "\n")
cat("生成的文件:\n")
cat("- Bacteria_Virus_Correlation_MI_Group.pdf (MI组热图)\n")
cat("- Bacteria_Virus_Correlation_CON_Group.pdf (CON组热图)\n")
cat("- Bacteria_Virus_Correlation_Both_Groups.pdf (两组并排热图)\n")
cat("- correlation_matrix_MI.csv (MI组相关性矩阵)\n")
cat("- correlation_matrix_CON.csv (CON组相关性矩阵)\n")
cat("- pvalue_matrix_MI.csv (MI组P值矩阵)\n")
cat("- pvalue_matrix_CON.csv (CON组P值矩阵)\n")
# 显示统计信息
cat("\n分析统计:\n")
cat("MI组 - 样本数:", length(mi_samples), "显著相关性:", sum(pval_matrix_mi < 0.05, na.rm = TRUE), "\n")
cat("CON组 - 样本数:", length(con_samples), "显著相关性:", sum(pval_matrix_con < 0.05, na.rm = TRUE), "\n")
